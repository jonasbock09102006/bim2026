<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BIM 2026 - REPAIR MODE</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { background: #000; color: white; font-family: sans-serif; display: grid; grid-template-columns: 250px 1fr; height: 100vh; overflow: hidden; }
        
        /* SIDEBAR */
        .sidebar { background: #111; border-right: 1px solid #333; padding: 15px; display: flex; flex-direction: column; gap: 10px; }
        .room-btn { padding: 10px; background: #222; border-radius: 5px; cursor: pointer; border: 1px solid transparent; }
        .room-btn.active { border-color: #3b82f6; background: #1e3a8a; }

        /* CHAT */
        .chat-wrap { display: flex; flex-direction: column; height: 100vh; background: #080808; }
        .header { height: 60px; background: #151515; display: flex; align-items: center; padding: 0 20px; justify-content: space-between; border-bottom: 1px solid #333; }
        #messages { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 8px; }
        .footer { height: 80px; background: #111; padding: 15px; display: flex; gap: 10px; border-top: 1px solid #333; }

        /* VIDEO */
        #video-grid { position: fixed; top: 10px; right: 10px; width: 250px; z-index: 999; pointer-events: none; }
        video { width: 100%; border-radius: 8px; border: 2px solid #3b82f6; background: #000; pointer-events: auto; margin-bottom: 5px; }

        input { background: #000; border: 1px solid #444; color: white; padding: 10px; border-radius: 5px; }
        .btn { padding: 8px 12px; border: none; border-radius: 5px; cursor: pointer; color: white; font-weight: bold; }
        .btn-blue { background: #3b82f6; }
        .btn-green { background: #22c55e; }
        .btn-red { background: #ef4444; }

        .msg { padding: 10px; border-radius: 8px; max-width: 80%; }
        .sent { align-self: flex-end; background: #3b82f6; }
        .recv { align-self: flex-start; background: #333; }
    </style>
</head>
<body>

<div id="video-grid"></div>

<div class="sidebar">
    <div id="auth-ui">
        <input id="email" type="email" placeholder="E-Mail" style="width:100%; margin-bottom:5px">
        <input id="password" type="password" placeholder="Passwort" style="width:100%; margin-bottom:10px">
        <button class="btn btn-blue" style="width:100%" onclick="login()">Login</button>
    </div>
    <div id="user-ui" style="display:none">
        <div id="u-mail" style="font-size:12px; color:#3b82f6"></div>
        <div style="font-size:11px">Call-ID: <b id="u-id" style="color:#22c55e"></b></div>
        <button class="btn btn-red" style="width:100%; margin-top:10px; font-size:10px" onclick="location.reload()">Logout</button>
    </div>
    <hr style="opacity:0.2">
    <button class="btn btn-blue" onclick="newRoom()">+ Raum</button>
    <div id="room-box" style="margin-top:10px"></div>
</div>

<div class="chat-wrap">
    <div class="header">
        <b id="room-name">Lade...</b>
        <div id="controls" style="display:none; gap:5px">
            <button class="btn btn-green" onclick="callAll()">游 Call Alle</button>
            <button class="btn btn-blue" onclick="addU()">+</button>
            <button class="btn btn-red" onclick="remU()">-</button>
            <button class="btn btn-red" onclick="delR()">游딈</button>
        </div>
    </div>
    <div id="messages"></div>
    <div class="footer">
        <input type="text" id="msgInput" placeholder="Nachricht..." style="flex:1">
        <button class="btn btn-blue" onclick="send()">Senden</button>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp, where, doc, updateDoc, arrayUnion, arrayRemove, deleteDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyB9Mw9ljgqeJztFtBEM2H7-c6k7XGy8zAw",
        authDomain: "projektmangerbim2026.firebaseapp.com",
        projectId: "projektmangerbim2026",
        storageBucket: "projektmangerbim2026.appspot.com",
        messagingSenderId: "88720534809",
        appId: "1:88720534809:web:4da70e450799e1cc80a988"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    let activeR = "Hauptraum", myID, unsub, peer;

    // LOGIN
    window.login = async () => {
        const e = document.getElementById('email').value;
        const p = document.getElementById('password').value;
        try { await signInWithEmailAndPassword(auth, e, p); } 
        catch { await createUserWithEmailAndPassword(auth, e, p).catch(err => alert("Fehler: " + err.message)); }
    };

    onAuthStateChanged(auth, u => {
        if(u) {
            document.getElementById('auth-ui').style.display='none';
            document.getElementById('user-ui').style.display='block';
            document.getElementById('u-mail').innerText = u.email;
            myID = u.uid.substring(0,5);
            document.getElementById('u-id').innerText = myID;
            initPeer(myID); loadRooms(); switchR('Hauptraum', '游닉 Hauptraum');
        }
    });

    // R츿UME
    function loadRooms() {
        onSnapshot(query(collection(db, "teams"), where("members", "array-contains", myID)), snap => {
            const b = document.getElementById('room-box');
            b.innerHTML = `<div class="room-btn ${activeR==='Hauptraum'?'active':''}" onclick="switchR('Hauptraum','游닉 Hauptraum')">游닉 Hauptraum</div>`;
            snap.forEach(d => {
                b.innerHTML += `<div class="room-btn ${activeR===d.id?'active':''}" onclick="switchR('${d.id}','${d.data().name}')">游논 ${d.data().name}</div>`;
            });
        });
    }

    window.switchR = (id, n) => {
        activeR = id;
        document.getElementById('room-name').innerText = n;
        document.getElementById('controls').style.display = (id==='Hauptraum'?'none':'flex');
        loadChat(); loadRooms();
    };

    window.newRoom = async () => {
        const n = prompt("Name:");
        if(n) await addDoc(collection(db, "teams"), {name:n, members:[myID], owner:auth.currentUser.uid});
    };

    window.addU = async () => {
        const id = prompt("ID hinzuf칲gen:");
        if(id) await updateDoc(doc(db,"teams",activeR), {members: arrayUnion(id.trim())});
    };

    window.remU = async () => {
        const id = prompt("ID entfernen:");
        if(id) await updateDoc(doc(db,"teams",activeR), {members: arrayRemove(id.trim())});
    };

    window.delR = async () => {
        const d = await getDoc(doc(db, "teams", activeR));
        if(d.data().owner === auth.currentUser.uid && confirm("L칬schen?")) {
            await deleteDoc(doc(db, "teams", activeR));
            switchR('Hauptraum', '游닉 Hauptraum');
        }
    };

    // CHAT (Senden & Empfangen)
    function loadChat() {
        if(unsub) unsub();
        const q = query(collection(db,"messages"), where("room","==",activeR), orderBy("timestamp","asc"));
        unsub = onSnapshot(q, snap => {
            const b = document.getElementById('messages'); b.innerHTML = "";
            snap.forEach(ds => {
                const m = ds.data();
                const isMe = m.uid === auth.currentUser.uid;
                b.innerHTML += `<div class="msg ${isMe?'sent':'recv'}"><small style="display:block;font-size:9px">${m.user}</small>${m.text}</div>`;
            });
            b.scrollTop = b.scrollHeight;
        }, err => console.error("Chat Fehler: ", err));
    }

    window.send = async () => {
        const i = document.getElementById('msgInput');
        if(!i.value.trim()) return;
        try {
            await addDoc(collection(db,"messages"), {
                text: i.value, user: auth.currentUser.email.split('@')[0], 
                uid: auth.currentUser.uid, room: activeR, timestamp: serverTimestamp()
            });
            i.value = "";
        } catch(e) { alert("Senden fehlgeschlagen: " + e.message); }
    };

    // VIDEO (PeerJS)
    function initPeer(id) {
        peer = new Peer(id);
        peer.on('call', async call => {
            const s = await navigator.mediaDevices.getUserMedia({video:true, audio:true});
            call.answer(s); setupV(call);
        });
    }

    window.callAll = async () => {
        const d = await getDoc(doc(db, "teams", activeR));
        const s = await navigator.mediaDevices.getUserMedia({video:true, audio:true});
        d.data().members.forEach(m => { if(m !== myID) setupV(peer.call(m, s)); });
    };

    function setupV(call) {
        call.on('stream', s => {
            if(document.getElementById('v-'+call.peer)) return;
            const v = document.createElement('video');
            v.id = 'v-'+call.peer; v.autoplay = true; v.srcObject = s;
            document.getElementById('video-grid').appendChild(v);
            v.onclick = () => { v.remove(); call.close(); };
        });
    }

    document.getElementById('msgInput').onkeypress = e => e.key==='Enter' && send();
</script>
</body>
</html>
