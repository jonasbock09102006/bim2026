<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BIM 2026 - REPAIR MODE</title>
    <style>
        /* CSS RESET */
        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
        html, body { height: 100%; width: 100%; overflow: hidden; background: #000; color: #fff; font-family: sans-serif; }

        /* GRID LAYOUT - Verhindert Ãœberlappung komplett */
        .app-wrapper {
            display: grid;
            grid-template-columns: 280px 1fr;
            height: 100vh;
            width: 100vw;
        }

        /* SIDEBAR */
        .sidebar {
            background: #111;
            border-right: 2px solid #333;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            z-index: 10;
        }

        .p-4 { padding: 15px; }
        .auth-box { background: #222; border-bottom: 1px solid #333; }
        input { width: 100%; padding: 12px; margin-bottom: 10px; border-radius: 5px; border: 1px solid #444; background: #000; color: #fff; font-size: 14px; }
        
        .room-card { 
            background: #252525; padding: 15px; margin-bottom: 10px; border-radius: 8px; 
            cursor: pointer; border: 2px solid transparent;
        }
        .room-card.active { border-color: #3b82f6; background: #1e3a8a; }
        .btn { padding: 8px 12px; border: none; border-radius: 4px; color: #fff; cursor: pointer; font-weight: bold; margin-top: 5px; }

        /* CHAT BEREICH */
        .chat-area {
            display: flex;
            flex-direction: column;
            background: #0b0b0b;
            position: relative;
        }

        #chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .input-footer {
            padding: 15px;
            background: #111;
            border-top: 2px solid #333;
            display: flex;
            gap: 10px;
        }

        #msgInput { flex: 1; margin-bottom: 0; border-radius: 20px; padding-left: 20px; }

        /* MESSAGES */
        .m { max-width: 80%; padding: 10px 15px; border-radius: 15px; font-size: 15px; line-height: 1.4; }
        .sent { align-self: flex-end; background: #3b82f6; }
        .recv { align-self: flex-start; background: #333; }
        .edit-tools { font-size: 10px; margin-top: 5px; opacity: 0.5; cursor: pointer; }
    </style>
</head>
<body>

    <div class="app-wrapper">
        <div class="sidebar">
            <div class="auth-box p-4">
                <div id="login-ui">
                    <input type="email" id="email" placeholder="E-Mail">
                    <input type="password" id="password" placeholder="Passwort">
                    <button class="btn" style="background: #22c55e; width: 100%;" onclick="doAuth()">Login</button>
                </div>
                <div id="user-ui" style="display:none">
                    <div id="u-mail" style="font-size: 12px; color: #3b82f6; font-weight: bold;"></div>
                    <div style="font-size: 11px;">ID: <b id="u-id" style="color:#22c55e"></b></div>
                    <button class="btn" style="background: #444; width: 100%; font-size: 11px;" onclick="doLogout()">Logout</button>
                </div>
            </div>
            
            <div class="p-4">
                <button class="btn" style="background: #3b82f6; width: 100%; margin-bottom: 20px;" onclick="addRoom()">+ Neuer Raum</button>
                <div id="room-list"></div>
            </div>
        </div>

        <div class="chat-area">
            <div id="chat-messages"></div>
            <div class="input-footer">
                <input type="text" id="msgInput" placeholder="Nachricht...">
                <button class="btn" style="background: #3b82f6; border-radius: 50%; width: 45px; height: 45px;" onclick="send()">âž¤</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp, where, doc, updateDoc, arrayUnion, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyB9Mw9ljgqeJztFtBEM2H7-c6k7XGy8zAw",
            authDomain: "projektmangerbim2026.firebaseapp.com",
            projectId: "projektmangerbim2026",
            storageBucket: "projektmangerbim2026.appspot.com",
            messagingSenderId: "88720534809",
            appId: "1:88720534809:web:4da70e450799e1cc80a988"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        let activeRoom = "Hauptraum", myID, unsub;

        window.doAuth = async () => {
            const e = document.getElementById('email').value;
            const p = document.getElementById('password').value;
            try { await signInWithEmailAndPassword(auth, e, p); } 
            catch { await createUserWithEmailAndPassword(auth, e, p).catch(err => alert(err.message)); }
        };

        window.doLogout = () => signOut(auth).then(() => location.reload());

        onAuthStateChanged(auth, u => {
            if(u) {
                document.getElementById('login-ui').style.display='none';
                document.getElementById('user-ui').style.display='block';
                document.getElementById('u-mail').innerText = u.email;
                myID = u.uid.substring(0,5);
                document.getElementById('u-id').innerText = myID;
                loadRooms(); switchRoom('Hauptraum');
            }
        });

        function loadRooms() {
            onSnapshot(query(collection(db, "teams"), where("members", "array-contains", myID)), snap => {
                const box = document.getElementById('room-list');
                box.innerHTML = `<div class="room-card ${activeRoom==='Hauptraum'?'active':''}" onclick="switchRoom('Hauptraum')">ðŸ“¢ Hauptraum</div>`;
                snap.forEach(d => {
                    const r = d.data();
                    const div = document.createElement('div');
                    div.className = `room-card ${activeRoom===d.id?'active':''}`;
                    div.innerHTML = `
                        <div onclick="switchRoom('${d.id}')"><b>ðŸ‘¥ ${r.name}</b></div>
                        <button class="btn" style="background:#22c55e; font-size:10px" onclick="invite(event,'${d.id}')">ID +</button>
                        ${r.owner===auth.currentUser.uid ? `<button class="btn" style="background:#ef4444; font-size:10px" onclick="delRoom(event,'${d.id}')">LÃ¶schen</button>` : ''}
                    `;
                    box.appendChild(div);
                });
            });
        }

        window.addRoom = async () => {
            const n = prompt("Raum Name:");
            if(n) await addDoc(collection(db,"teams"), {name:n, members:[myID], owner:auth.currentUser.uid});
        };

        window.invite = async (e, id) => {
            e.stopPropagation();
            const target = prompt("ID der Person:");
            if(target) await updateDoc(doc(db,"teams",id), {members:arrayUnion(target.trim())});
        };

        window.delRoom = async (e, id) => {
            e.stopPropagation();
            if(confirm("Raum lÃ¶schen?")) { await deleteDoc(doc(db, "teams", id)); switchRoom('Hauptraum'); }
        };

        window.switchRoom = (id) => {
            activeRoom = id;
            loadChat();
        }

        function loadChat() {
            if(unsub) unsub();
            unsub = onSnapshot(query(collection(db,"messages"), where("room","==",activeRoom), orderBy("timestamp","asc")), snap => {
                const box = document.getElementById('chat-messages');
                box.innerHTML = "";
                snap.forEach(docSnap => {
                    const m = docSnap.data();
                    const isMe = m.uid === auth.currentUser.uid;
                    const div = document.createElement('div');
                    div.className = `m ${isMe?'sent':'recv'}`;
                    div.innerHTML = `
                        <div style="font-size:9px; opacity:0.5">${m.user}</div>
                        ${m.text}
                        ${isMe ? `<div class="edit-tools" onclick="editMsg('${docSnap.id}','${m.text}')">Bearbeiten | LÃ¶schen</div>` : ''}
                    `;
                    box.appendChild(div);
                });
                box.scrollTop = box.scrollHeight;
            });
        }

        window.send = async () => {
            const i = document.getElementById('msgInput');
            if(!i.value.trim()) return;
            await addDoc(collection(db,"messages"), {text:i.value, user:auth.currentUser.email.split('@')[0], uid:auth.currentUser.uid, room:activeRoom, timestamp:serverTimestamp()});
            i.value = "";
        };

        window.editMsg = async (id, old) => {
            const n = prompt("Neu (leer zum LÃ¶schen):", old);
            if(n === "") await deleteDoc(doc(db,"messages",id));
            else if(n && n !== old) await updateDoc(doc(db,"messages",id), {text:n});
        };

        document.getElementById('msgInput').onkeypress = e => e.key==='Enter' && send();
    </script>
</body>
</html>
